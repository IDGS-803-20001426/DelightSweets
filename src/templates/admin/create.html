{% extends 'admin/model/create.html' %}
{% import 'admin/model/layout.html' as model_layout with context %}

{% block body %}
    {{ super() }}

    <!-- Modal de confirmación -->
    <div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-labelledby="confirmModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalLabel">Confirmación</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    ¿Estás seguro de que deseas guardar los cambios?
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary">Guardar</button>
                </div>
            </div>
        </div>
    </div>
{% endblock body %}

{% block tail %}
{{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            $('#nombre_producto').change(function() {
                var id_producto = $(this).val();
                console.log(id_producto);
                var csrfToken = document.querySelector('input[name="csrf_token"]').value;
                console.log('CSRF Token:', csrfToken);
                // Realiza una solicitud AJAX para obtener el costo de la materia prima
                $.ajax({
                    url: '/obtener_costo',  // Ruta de tu endpoint Flask para obtener el costo
                    type: 'POST',
                    headers: {'X-CSRFToken': csrfToken},
                    data: {'id_producto': id_producto},
                    success: function(response) {
                        // Actualiza el campo de costo con el valor obtenido
                        $('#costo_oculto').val(response.costo);
                    },
                    error: function(xhr, status, error) {
                        console.error('Error al obtener el costo:', error);
                    }
                });
            });
        });

      document.addEventListener('DOMContentLoaded', function() {
        // Seleccionar el botón de "Guardar" y cambiar su texto
        var saveButton = document.querySelector('input[type="submit"][value="Save"]');
        if (saveButton) {
            saveButton.value = 'Guardar';
            saveButton.addEventListener('click', function(event) {
                // Mostrar una alerta de confirmación
                
                var costoMateriaPrima = parseFloat(document.getElementById('precio_compra').value);
                var costoMateriaPrimaBD = parseFloat(document.getElementById('costo_oculto').value);
                var costoMateriaPrimaCadaUno = costoMateriaPrima/parseFloat(document.getElementById('cantidad').value);
                // Si el usuario confirma, continúa con el envío del formulario
                if(costoMateriaPrima>costoMateriaPrimaBD){
                    event.preventDefault();
                    var self = this;
                    Swal.fire({
                        title: '¿Estás seguro de que deseas guardar los cambios?',
                        text: '¿Quieres actualizar el precio de la materia prima? El precio actual es de ' + costoMateriaPrimaBD.toFixed(2) + ' y el ingresado es de ' + costoMateriaPrimaCadaUno.toFixed(2),
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Guardar',
                        cancelButtonText: 'Cancelar'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            document.cookie = 'pruebas=true';
                            self.form.submit();
                            // event.preventDefault();
                        } else {
                            document.cookie = 'pruebas=false';
                            self.form.submit();
                        }
                    });
                    // var confirmacion = confirm('¿Estás seguro de que deseas guardar los cambios?');
                    // if (confirmacion) {
                    //     document.cookie = 'pruebas=true';
                    //     // event.preventDefault();
                    // }else{
                    //     document.cookie = 'pruebas=false';    
                    // }
                }else{
                    document.cookie = 'pruebas=false'; 
                }
            });
        }
      });
    </script>
{% endblock tail %}
