{% import 'admin/layout.html' as layout with context -%}
{% import 'admin/static.html' as admin_static with context %}
<!DOCTYPE html>
<html>

<head>
  <title>{% block title %}{% if admin_view.category %}{{ admin_view.category }} - {% endif %}{{ admin_view.name }} -
    {{ admin_view.admin.name }}{% endblock title%}</title>

  {% block head_meta %}
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Flask-Admin dashboard login template">
  <meta name="author" content="Jonathan Ars">
  {% endblock head_meta %}

  {% block head_css %}
  <!-- Bootstrap 3.3.6 -->
  <link href="{{url_for('static',filename='css/bootstrap.min.css')}}" rel="stylesheet">
  </link>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <!-- <link rel="stylesheet" href="{{url_for('static',filename='plugins/fontawesome/5.15.4/all.min.css')}}"> -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ionicons/2.0.1/css/ionicons.min.css">
  <!-- <link rel="stylesheet" href="{{url_for('static',filename='plugins/ionicons/2.0.1/ionicons.min.css')}}"> -->
  <!-- Theme style -->
  <link href="{{url_for('static',filename='css/AdminLTE.min.css')}}" rel="stylesheet">
  </link>
  <!-- AdminLTE Skins. Choose a skin from the css/skins folder instead of downloading all of them to reduce the load. -->
  <link href="{{url_for('static',filename='css/skins/_all-skins.min.css')}}" rel="stylesheet">
  </link>
  <!-- iCheck -->
  <link href="{{url_for('static',filename='plugins/iCheck/flat/blue.css')}}" rel="stylesheet">
  </link>
  <!-- Morris chart -->
  <link href="{{url_for('static',filename='plugins/morris/morris.css')}}" rel="stylesheet">
  </link>
  <!-- jvectormap -->
  <link href="{{url_for('static',filename='plugins/jvectormap/jquery-jvectormap-1.2.2.css')}}" rel="stylesheet">
  </link>
  <!-- Date Picker -->
  <link href="{{url_for('static',filename='plugins/datepicker/datepicker3.css')}}" rel="stylesheet">
  </link>
  <!-- Daterange picker -->
  <link href="{{url_for('static',filename='plugins/daterangepicker/daterangepicker.css')}}" rel="stylesheet">
  </link>
  <!-- bootstrap wysihtml5 - text editor -->
  <link href="{{url_for('static',filename='plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css')}}"
    rel="stylesheet">
  </link>

  <!-- SweetAlert -->
  <link href="{{url_for('static',filename='libraries/SweetAlert/sweetalert.min.css')}}" rel="stylesheet">
  </link>

  <!-- Flask-admin admin styles -->
  <link href="{{ admin_static.url(filename='admin/css/bootstrap3/admin.css', v='1.1.1') }}" rel="stylesheet">
  {% if admin_view.extra_css %}
  {% for css_url in admin_view.extra_css %}
  <link href="{{ css_url }}" rel="stylesheet">
  {% endfor %}
  {% endif %}

  {% endblock head_css%}

  {% block head %}
  {% endblock head%}

  {% block head_tail %}
  {% endblock head_tail%}

</head>


<body class="hold-transition skin-blue sidebar-mini">
  {% block page_body %}
  <div class="modal fade" id="cantidadModal" tabindex="-1" role="dialog" aria-labelledby="cantidadModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cantidadModalLabel">Ingrese la cantidad</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <label for="selectMateriasPrimas">Materias primas</label>
          <select class="form-control" aria-label="Default select example" id="selectMateriasPrimas"></select>
          <label for="cantidadMateriasPrimas">Cantidad</label>
          <div>
            <input type="number" class="form-control" name="" id="cantidadMateriasPrimas">
            <small class="text-danger" id="error-cantidad"></small>
          </div>
          <button type="button" class="btn btn-primary" style="margin: 5px 0;" id="registrarMateria">Guardar</button>

          <table id="tableMaterias" border="1" width="100%">
            <thead>
              <th width="25%" style="padding: 5px; display: none; text-align: center;">id_materia</th>
              <th width="25%" style="padding: 5px; text-align: center;">materia</th>
              <th width="25%" style="padding: 5px; text-align: center;">cantidad</th>
              <th width="25%" style="padding: 5px; text-align: center;">Acciones</th>
            </thead>
            <tbody id="materiasPrimasSeleccionadas">

            </tbody>
          </table>

        </div>
        {% if form %}
        {% if form.materias_primas %}
        {{ form.materias_primas(class="form-control") }}
        {% endif %}
        {% if form.cantidad %}
        {{ form.cantidad(class="form-control") }}
        {% endif %}
        {% if form.btn_materia %}
        {{ form.btn_materia(class="form-control") }}
        {% endif %}
        {% endif %}
        <div class="modal-footer">
          <!-- <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button> -->
          <button type="button" class="btn btn-primary" onclick="guardarCantidad()">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal fade bd-example-modal-sm" id="stockBajoModal" tabindex="-1" role="dialog"
    aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Galletas con stock bajo</h5>
        </div>
        <div class="modal-body" id="modal-body-stock-bajo">
          ...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
          <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="galletasCaducadasModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Galletas caducadas</h5>
        </div>
        <div class="modal-body" id="modal-body-galletas-caducadas">
          ...
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
          <button type="submit" form="form-galletas-caducadas" class="btn btn-primary">Enviar a mermas</button>
        </div>
      </div>
    </div>
  </div>




  <!-- TOP NAVBAR -->
  <div class="wrapper">
    {% if current_user.is_authenticated %}
    <header class="main-header">
      <!-- Logo -->
      {% block brand %}
      <a href="{{ admin_view.admin.url }}" class="logo">
        <!-- mini logo for sidebar mini 50x50 pixels -->
        <span class="logo-mini"><b>B<small>S</small></b></span>
        <!-- logo for regular state and mobile devices -->
        <span class="logo-lg"><b>{{ admin_view.admin.name }}</b></span>
      </a>
      {% endblock brand%}

      <!-- Header Navbar: style can be found in header.less -->
      <nav class="navbar navbar-static-top">
        <!-- Sidebar toggle button-->
        <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
          <span class="sr-only">Toggle navigation</span>
        </a>

        <div class="navbar-custom-menu">
          <ul class="nav navbar-nav">
            <!-- Colores Vista -->
            <li>
              <a href="#" data-toggle="control-sidebar"><i class="fa fa-gears"></i></a>
            </li>
            <li>
              {% block access_control %}
              {% endblock %}
            </li>
          </ul>
          {% block menu_links %}
          <ul class="nav navbar-nav navbar-right">
            {{ layout.menu_links() }}
          </ul>
          {% endblock %}
        </div>
      </nav>
    </header>
    <!-- / TOP NAVBAR -->

    <!-- LEFT MENU -->
    <aside class="main-sidebar">
      <section class="sidebar">
        <!-- Sidebar -->
        <div class="user-panel">
          <div class="pull-left image">
            <i class="fa fa-user-circle" style="color: white; font-size: 2.5em;"></i>
          </div>
          <div class="pull-left info">
            <p>
              {% if current_user.nombre_completo -%}
              {{ current_user.nombre_completo }}
              {%- endif %}
            </p>
            <a href="http://127.0.0.1:5000/admin/"><i class="fa fa-circle text-success"></i> Online</a>
          </div>
        </div>

        <!-- Opciones side-bar -->
        <ul class="sidebar-menu">
          <li class="header">NAVEGACIÃ“N</li>
          {% block main_menu %}
          {{ layout.menu() }}
          {% endblock %}
        </ul>
      </section>
      <!-- /.sidebar -->
    </aside>

    <!-- Content Wrapper. Contains page content color white-->
    <div class="content-wrapper">
      {% endif %}

      {% block messages %}
      {{ layout.messages() }}
      {% endblock messages %}

      {# store the jinja2 context for form_rules rendering logic #}
      {% set render_ctx = h.resolve_ctx() %}
      <div class="container">
        {% block body %}

        {% endblock body %}
      </div>
      {% if current_user.is_authenticated %}
    </div>

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
      <!-- Create the tabs -->
      <ul class="nav nav-tabs nav-justified control-sidebar-tabs">
        <li><a href="#control-sidebar-settings-tab" data-toggle="tab"><i class="fa fa-cog"></i></a></li>
      </ul>
      <!-- Tab panes -->
      <div class="tab-content">
        <div class="tab-pane" id="control-sidebar-stats-tab">Stats Tab Content</div>
        <div class="tab-pane" id="control-sidebar-settings-tab">
        </div>
      </div>
    </aside>


    <div class="control-sidebar-bg"></div>

    <footer class="main-footer">
      <strong>Copyright &copy; 2024 <a
          href="https://github.com/IDGS-803-20001426/DelightSweets">BackedSmiles</a></strong> -
      All rights reserved.
      <div class="pull-right hidden-xs">
        <b>Version</b> 1.0
      </div>
    </footer>
    {% endif %}

  </div>
  {% endblock page_body%}

  {% block tail_js %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      var ventasRecolectaLink = document.querySelector('a[href="/admin/ventas_recolecta/"]');
      if (ventasRecolectaLink) {
        ventasRecolectaLink.style.display = 'none';
      }
    });
  </script>
  <!-- jQuery 2.2.3 -->
  <script src="{{url_for('static',filename='plugins/jQuery/jquery-2.2.3.min.js')}}"></script>
  <!-- jQuery UI 1.11.4 -->
  <script src="{{url_for('static',filename='plugins/jQueryUI/jquery-ui.min.js')}}"></script>
  <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
  <script>
    $.widget.bridge('uibutton', $.ui.button);
  </script>
  <!-- Bootstrap 3.3.6 -->
  <script src="{{url_for('static',filename='js/bootstrap.min.js')}}"></script>
  <script src="{{ admin_static.url(filename='vendor/select2/select2.min.js', v='3.5.2') }}" type="text/javascript">
  </script>

  {% if admin_view.extra_js %}
  {% for js_url in admin_view.extra_js %}
  <script src="{{ js_url }}" type="text/javascript"></script>
  {% endfor %}
  {% endif %}

  <!-- Morris.js charts -->
  <script src="{{url_for('static',filename='plugins/raphael/2.1.0/raphael.min.js')}}"></script>
  <script src="{{url_for('static',filename='plugins/morris/morris.min.js')}}"></script>
  <!-- Sparkline -->
  <script src="{{url_for('static',filename='plugins/sparkline/jquery.sparkline.min.js')}}"></script>
  <!-- jvectormap -->
  <script src="{{url_for('static',filename='plugins/jvectormap/jquery-jvectormap-1.2.2.min.js')}}"></script>
  <script src="{{url_for('static',filename='plugins/jvectormap/jquery-jvectormap-world-mill-en.js')}}"></script>
  <!-- jQuery Knob Chart -->
  <script src="{{url_for('static',filename='plugins/knob/jquery.knob.js')}}"></script>
  <!-- daterangepicker -->
  <script src="{{url_for('static',filename='plugins/moment/2.11.2/moment.min.js')}}"></script>
  <script src="{{url_for('static',filename='plugins/daterangepicker/daterangepicker.js')}}"></script>
  <!-- datepicker -->
  <script src="{{url_for('static',filename='plugins/datepicker/bootstrap-datepicker.js')}}"></script>
  <!-- Bootstrap WYSIHTML5 -->
  <script src="{{url_for('static',filename='plugins/bootstrap-wysihtml5/bootstrap3-wysihtml5.all.min.js')}}"></script>
  <!-- Slimscroll -->
  <script src="{{url_for('static',filename='plugins/slimScroll/jquery.slimscroll.min.js')}}"></script>
  <!-- FastClick -->
  <script src="{{url_for('static',filename='plugins/fastclick/fastclick.js')}}"></script>
  <!-- AdminLTE App -->
  <script src="{{url_for('static',filename='js/app.min.js')}}"></script>
  <!-- AdminLTE for demo purposes -->
  <script src="{{url_for('static',filename='js/demo.js')}}"></script>
  <!-- Sweetalert -->
  <script src="{{url_for('static',filename='libraries/sweetalert/sweetalert.min.js')}}"></script>
  {% if admin_view.name=="Home" %}
  <script src="{{url_for('static',filename='js/pages/dashboard.js')}}"></script>
  {% endif %}
  <script>
    function confirmDelete(url) {

    }

    document.addEventListener("DOMContentLoaded", function () {
      var deleteButtons = document.querySelectorAll(
        '.fa-trash'
      ); // Esto seleccionarÃ¡ todos los iconos de basura (suponiendo que Flask-Admin use FontAwesome para los botones de eliminar)
      deleteButtons.forEach(function (icon) {
        icon.addEventListener('click', function (event) {
          event.preventDefault(); // Evita el comportamiento predeterminado de eliminar
          Swal.fire({
            title: 'Â¿EstÃ¡s seguro?',
            text: 'Â¡No podrÃ¡s deshacer esta acciÃ³n!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'SÃ­, eliminarlo!',
            cancelButtonText: 'Cancelar'
          }).then((result) => {
            if (result.isConfirmed) {
              // Si el usuario confirma, envÃ­a la solicitud de eliminaciÃ³n
              var deleteButton = icon
                .parentElement; // Obtener el elemento padre del icono (probablemente el botÃ³n de eliminar)
              deleteButton
                .click(); // Simula el clic en el botÃ³n para ejecutar la funciÃ³n original de eliminar
            }
          });


        });
      });
    });

    $(document).ready(function () {
      // Aplicar Select2 a todos los campos de selecciÃ³n mÃºltiple
      $('select[multiple]').select2();

      const tipoMermaInput = document.querySelector('input[name="tipo_merma"]:checked');
      const tipoMerma = tipoMermaInput ? tipoMermaInput.value : 0;
      if (tipoMerma === '1') {
        $("#select_galleta_individual, label[for='select_galleta_individual']").closest('.form-group').css(
          "display", "none");
        $("#cantidad_merma").closest('.form-group').css("display", "none");
      } else if (tipoMerma == '2') {
        $("#select_galleta_lote, label[for='select_galleta_lote']").closest('.form-group').css("display", "none");
        $("#cantidad_merma").closest('.form-group').css("display", "block");
      }

      const tipoMermaMateriaInput = document.querySelector('input[name="tipo_merma_materia"]:checked');
      const tipoMermaMateria = tipoMermaMateriaInput ? tipoMermaMateriaInput.value : 0
      if (tipoMermaMateria === '1') {
        $("#select_materia_individual, label[for='select_materia_individual']").closest('.form-group').css(
          "display", "none");
        $("#cantidad_merma_materia").closest('.form-group').css("display", "none");
      } else if (tipoMermaMateria == '2') {
        $("#select_materia_lote, label[for='select_materia_lote']").closest('.form-group').css("display", "none");
        $("#cantidad_merma_materia").closest('.form-group').css("display", "block");
      }
    });

    $('input[name="tipo_merma"]').on('change', function () {
      const tipoMerma = document.querySelector('input[name="tipo_merma"]:checked').value;
      if (tipoMerma === '1') {
        $("#select_galleta_lote, label[for='select_galleta_lote']").closest('.form-group').css("display", "block");
        $("#select_galleta_individual, label[for='select_galleta_individual']").closest('.form-group').css(
          "display", "none");
        $("#cantidad_merma").closest('.form-group').css("display", "none");
      } else {
        $("#select_galleta_individual, label[for='select_galleta_individual']").closest('.form-group').css(
          "display", "block");
        $("#select_galleta_lote, label[for='select_galleta_lote']").closest('.form-group').css("display", "none");
        $("#cantidad_merma").closest('.form-group').css("display", "block");
      }
    });

    $('input[name="tipo_merma_materia"]').on('change', function () {
      const tipoMermaMateria = document.querySelector('input[name="tipo_merma_materia"]:checked').value;
      if (tipoMermaMateria === '1') {
        $("#select_materia_lote, label[for='select_materia_lote']").closest('.form-group').css("display", "block");
        $("#select_materia_individual, label[for='select_materia_individual']").closest('.form-group').css(
          "display", "none");
        $("#cantidad_merma_materia").closest('.form-group').css("display", "none");
      } else {
        $("#select_materia_individual, label[for='select_materia_individual']").closest('.form-group').css(
          "display", "block");
        $("#select_materia_lote, label[for='select_materia_lote']").closest('.form-group').css("display", "none");
        $("#cantidad_merma_materia").closest('.form-group').css("display", "block");
      }
    });

    function abrirModal() {
      $("#cantidadModal").modal("show");
    }

    $("#btnStockBajo").click(function () {
      fetch('/consultarStockBajo', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            // 'X-CSRFToken': csrf_token // Agregar el token CSRF como encabezado
          }
        })
        .then(response => {
          if (response.ok) {
            return response.json();
          } else {
            throw new Error('Error en la solicitud');
          }
        })
        .then(data => {
          let gall = '<table class="table table-striped">' +
            '<thead>' +
            '  <tr>' +
            '    <th scope="col">Nombre</th>' +
            '    <th scope="col">Cantidad</th>' +
            '  </tr>' +
            '</thead>' +
            '<tbody>';
          data.forEach(function (galleta) {
            gall += '<tr>' +
              '<td>' + galleta.nombre + '</td>' +
              '<td>' + galleta.cantidad + ' pz</td>' +
              '</tr>';
          });

          gall += '</tbody>' +
            '</table>';
          $("#modal-body-stock-bajo").html(gall);

          $("#stockBajoModal").modal("show");
        })
        .catch(error => {
          // Manejar errores de red u otros errores
          console.error('Error de red:', error);
        });
    });

    $("#btnGalletasCaducadas").click(function () {


      fetch('/consultarGalletasCaducadas', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
            // 'X-CSRFToken': csrf_token // Agregar el token CSRF como encabezado
          }
        })
        .then(response => {
          if (response.ok) {
            return response.json();
          } else {
            throw new Error('Error en la solicitud');
          }
        })
        .then(data => {
          let gall =
            '<form id="form-galletas-caducadas"><input type="hidden" name="csrf_token_form" value="{{ csrf_token() }}"><table class="table table-striped">' +
            '<thead>' +
            '  <tr>' +
            '    <th scope="col"></th>' +
            '    <th scope="col">Nombre</th>' +
            '    <th scope="col">Fecha producciÃ³n</th>' +
            '    <th scope="col">Cantidad</th>' +
            '  </tr>' +
            '</thead>' +
            '<tbody>';
          data.forEach(function (galleta) {
            gall += '<tr>' +
              '<td>' +
              '  <div class="form-check">' +
              '    <input class="form-check-input" type="checkbox" name="id_inventario" value="' + galleta
              .id_inventario_prod_terminado + '" id="flexCheckChecked">' +
              ' </div>' +
              '</td>' +
              '<td>' + galleta.nombre + '</td>';

            // Crear un objeto Date con la cadena de fecha
            var fecha = new Date(galleta.fecha_produccion);
            // Formatear la fecha en un formato mÃ¡s legible
            var opcionesDeFormato = {
              weekday: 'long',
              year: 'numeric',
              month: 'long',
              day: 'numeric',
              hour: 'numeric',
              minute: 'numeric',
              second: 'numeric',
              timeZoneName: 'short'
            };
            var fechaLegible = fecha.toLocaleDateString('es-MX', opcionesDeFormato);

            gall += '<td>' + fechaLegible + '</td>' +
              '<td>' + galleta.cantidad + ' pz</td>' +
              '</tr>';
          });

          gall += '</tbody>' +
            '</table></form>';

          $("#modal-body-galletas-caducadas").html(gall);

          $("#galletasCaducadasModal").modal("show");
        })
        .catch(error => {
          // Manejar errores de red u otros errores
          console.error('Error de red:', error);
        });

    });

    $(document).on('submit', '#form-galletas-caducadas', function (event) {
      event.preventDefault(); // Evitar el envÃ­o del formulario por defecto

      let csrf_token = $("input[name=csrf_token_form]").val();

      // Array para almacenar los valores de los checks marcados
      let checksSeleccionados = [];

      // Obtener todos los elementos de tipo checkbox dentro del formulario
      $('#form-galletas-caducadas input[type="checkbox"]').each(function () {
        // Verificar si el checkbox estÃ¡ marcado
        if ($(this).is(':checked')) {
          // Si estÃ¡ marcado, agregar su valor al array
          checksSeleccionados.push($(this).val());
        }
      });

      // Verificar si se han seleccionado elementos antes de enviar la peticiÃ³n
    if (checksSeleccionados.length === 0) {
        // Mostrar un mensaje de error
        Swal.fire({
            title: "Error!",
            text: "Por favor, selecciona al menos un elemento antes de enviar el formulario.",
            icon: "error"
        });
        return; // Detener la ejecuciÃ³n de la funciÃ³n
    }

      // Hacer una solicitud fetch a la ruta de Flask
      fetch('/actualizar_estado', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrf_token // Agregar el token CSRF como encabezado
          },
          body: JSON.stringify({
            checks: checksSeleccionados
          })
        })
        .then(response => {
          if (response.ok) {
            // La solicitud se completÃ³ con Ã©xito
            // Realizar cualquier acciÃ³n adicional necesaria
            Swal.fire({
              title: "Ã‰xito!",
              text: "El lote se registrÃ³ como merma!",
              icon: "success"
            }).then((result) => {
              // Recargar la pÃ¡gina
              window.location.reload();
            });
          } else {
            Swal.fire({
              title: "Error!",
              text: "OcurriÃ³ un error al realizar el movimiento!",
              icon: "error"
            });
          }
        })
        .catch(error => {
          // Manejar errores de red u otros errores
          console.error('Error de red:', error);
        });
    });


    // FunciÃ³n para enviar la cantidad al backend
    function guardarCantidad() {
      var datos = [];

      // Recorrer cada fila de la tabla, excluyendo la fila de encabezado (thead)
      // Recorrer cada fila de la tabla, excluyendo la fila de encabezado (thead)
      $('#materiasPrimasSeleccionadas tr').each(function () {
        var fila = {};
        $(this).find('td').each(function (colIndex) {
          console.log($('#tableMaterias thead th').eq(colIndex).text())
          var nombreColumna = $('#tableMaterias thead th').eq(colIndex)
            .text(); // Obtener el nombre de la columna
          fila[nombreColumna] = $(this)
            .text(); // Asignar el texto de la celda al objeto de fila usando el nombre de la columna como clave
        });
        // Agregar el objeto de fila al arreglo de datos
        datos.push(fila);
      });

      $("#datos_materias_primas").val(JSON.stringify(datos));

      $('#cantidadModal').modal('hide');
    }

    $("#registrarMateria").click(function () {
      $("#error-cantidad").html("");
      const idMateria = $("#selectMateriasPrimas").val();
      const nombre = $("#selectMateriasPrimas option:selected").text()
      const cantidad = $("#cantidadMateriasPrimas").val();

      if (cantidad <= 0 || cantidad == "") {
        $("#error-cantidad").append("Se necesita una cantidad");
        return;
      }

      var fechaActual = new Date();
      var numeroAleatorio = Math.floor(10000 + Math.random() * 90000);
      $("#materiasPrimasSeleccionadas").append("<tr><td style='display: none;'>" + idMateria +
        "</td><td style='padding: 2px;'>" + nombre + "</td><td style='padding: 2px;'>" + cantidad +
        "</td><td style='padding: 2px;'><button class='eliminar btn btn-danger' id='" + fechaActual.getTime() +
        numeroAleatorio + "'>Eliminar</button></td></tr>")
    });

    $('#materiasPrimasSeleccionadas').on('click', '.eliminar', function () {
      console.log("hoal")
      $(this).closest('tr').remove(); // Eliminar la fila mÃ¡s cercana
    });

    $("#btn_modal").click(function () {
      $("#materiasPrimasSeleccionadas").html("");

      var datos = $("#datos_materias_primas").val();
      var datos_json = JSON.parse(datos);

      var fechaActual = new Date();
      var numeroAleatorio = Math.floor(10000 + Math.random() * 90000);
      datos_json.forEach(function (materias) {
        $("#materiasPrimasSeleccionadas").append("<tr><td style='display: none;'>" + materias['id_materia'] +
          "</td><td style='padding: 2px;'>" + materias['materia'] + "</td><td style='padding: 2px;'>" +
          materias['cantidad'] +
          "</td><td style='padding: 2px;'><button class='eliminar btn btn-danger' id='" + fechaActual
          .getTime() + numeroAleatorio + "'>Eliminar</button></td></tr>")
      });

    });

    fetch('/materias_primas')
      .then(response => response.json())
      .then(data => {
        // Llenar el campo de selecciÃ³n con las opciones recibidas
        const select = document.getElementById('selectMateriasPrimas');
        data.forEach(opcion => {
          const option = document.createElement('option');
          option.value = opcion.id;
          option.text = opcion.nombre;
          select.appendChild(option);
        });
      })
      .catch(error => {
        console.error('Error al obtener las opciones de materias primas:', error);
      });
  </script>

  {% endblock tail_js%}

  {% block tail %}
  {% endblock tail %}

</body>

</html>